# 帖子存储方案说明

## 📋 当前优化内容

### 1. **大文本存储（1万字+）**

**数据库字段类型：**
- `content` 字段使用 `@db.LongText`（MySQL LONGTEXT 类型）
- **容量限制**：最大 4GB（约 40 亿字符）
- **实际使用**：1 万字 ≈ 10KB，完全足够

**示例：**
```prisma
content String @db.LongText  // 支持超大文本内容
```

### 2. **富文本格式支持**

**新增字段：**
- `contentType`：标识内容格式类型
  - `TEXT`：纯文本（默认）
  - `HTML`：HTML 格式（支持富文本编辑器）
  - `MARKDOWN`：Markdown 格式（支持 Markdown 语法）

**使用场景：**
- **纯文本**：简单文字内容
- **HTML**：需要复杂格式（加粗、斜体、链接、列表等）
- **Markdown**：程序员友好，支持代码块、表格等

### 3. **图片存储方案**

#### 方案 A：JSON 字符串（当前方案）
```json
// images 字段存储 JSON 数组
["https://example.com/img1.jpg", "https://example.com/img2.jpg"]
// 或 base64（不推荐，体积大）
["data:image/jpeg;base64,/9j/4AAQSkZJRg..."]
```

**优点：**
- 简单，无需额外表
- 适合少量图片（< 10 张）

**缺点：**
- Base64 体积增大 33%
- 查询性能一般

#### 方案 B：单独图片表（推荐用于大量图片）
```prisma
model PostImage {
  id        String   @id @default(uuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  url       String   // 图片URL
  order     Int      @default(0)  // 排序
  createdAt DateTime @default(now())
  
  @@index([postId])
}
```

**优点：**
- 查询性能好
- 支持图片元数据（大小、格式等）
- 便于图片管理

#### 方案 C：对象存储（生产环境推荐）
- 上传到 **AWS S3**、**阿里云 OSS**、**腾讯云 COS**
- 数据库只存储 URL
- 支持 CDN 加速

## 🚀 实施步骤

### 步骤 1：更新数据库 Schema
```bash
# 生成 Prisma Client
npm run db:generate

# 推送到数据库（开发环境）
npm run db:push

# 或创建迁移（生产环境）
npm run db:migrate
```

### 步骤 2：更新 API 路由

**创建帖子时指定格式：**
```typescript
// app/api/posts/route.ts
await prisma.post.create({
  data: {
    title: "标题",
    content: "<p>这是HTML内容</p>",  // 或 Markdown
    contentType: "HTML",  // 或 "MARKDOWN"
    images: JSON.stringify(imageUrls),  // 存储URL数组
    // ...
  }
})
```

### 步骤 3：前端显示

**根据 contentType 渲染：**
```tsx
// app/posts/[id]/page.tsx
{post.contentType === 'HTML' && (
  <div dangerouslySetInnerHTML={{ __html: post.content }} />
)}
{post.contentType === 'MARKDOWN' && (
  <ReactMarkdown>{post.content}</ReactMarkdown>
)}
{post.contentType === 'TEXT' && (
  <div className="whitespace-pre-wrap">{post.content}</div>
)}
```

## 📊 存储容量对比

| 内容类型 | 1万字 | 10万字 | 100万字 |
|---------|-------|--------|---------|
| 纯文本 | ~10KB | ~100KB | ~1MB |
| HTML | ~15KB | ~150KB | ~1.5MB |
| Markdown | ~12KB | ~120KB | ~1.2MB |
| Base64图片(1张) | ~100KB | ~100KB | ~100KB |

**结论：** LONGTEXT（4GB）完全足够，即使包含大量图片 URL。

## 💡 最佳实践

### 1. **图片处理**
- ✅ **推荐**：上传到对象存储，存储 URL
- ❌ **不推荐**：Base64 直接存数据库（体积大）

### 2. **内容格式选择**
- **简单文字**：使用 `TEXT`
- **需要格式**：使用 `HTML` 或 `MARKDOWN`
- **代码分享**：使用 `MARKDOWN`（支持代码高亮）

### 3. **性能优化**
- 长文本内容使用分页加载
- 图片使用懒加载（`loading="lazy"`）
- 考虑添加内容摘要字段（`excerpt`）

## 🔧 后续优化建议

1. **添加内容摘要字段**
   ```prisma
   excerpt String? @db.VarChar(500)  // 前500字作为摘要
   ```

2. **图片单独表**（如果图片数量多）
   ```prisma
   model PostImage {
     id        String   @id @default(uuid())
     postId    String
     url       String
     order     Int      @default(0)
     // ...
   }
   ```

3. **富文本编辑器集成**
   - **TinyMCE**：功能强大
   - **Quill**：轻量级
   - **Markdown Editor**：支持 Markdown

4. **内容搜索优化**
   - 使用全文索引（MySQL FULLTEXT）
   - 或集成 Elasticsearch

## 📝 示例代码

### 创建带格式的帖子
```typescript
// HTML 格式
await prisma.post.create({
  data: {
    title: "我的帖子",
    content: "<h1>标题</h1><p>这是<strong>加粗</strong>内容</p>",
    contentType: "HTML",
    images: JSON.stringify(["https://example.com/img.jpg"]),
    // ...
  }
})

// Markdown 格式
await prisma.post.create({
  data: {
    title: "技术分享",
    content: "# 标题\n\n这是**加粗**内容\n\n```js\nconsole.log('hello')\n```",
    contentType: "MARKDOWN",
    // ...
  }
})
```

### 前端渲染
```tsx
import ReactMarkdown from 'react-markdown'

function PostContent({ post }) {
  if (post.contentType === 'HTML') {
    return <div dangerouslySetInnerHTML={{ __html: post.content }} />
  }
  if (post.contentType === 'MARKDOWN') {
    return <ReactMarkdown>{post.content}</ReactMarkdown>
  }
  return <div className="whitespace-pre-wrap">{post.content}</div>
}
```
