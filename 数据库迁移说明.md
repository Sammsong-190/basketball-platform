# 数据库迁移说明 - 帖子存储优化

## 📋 本次更新内容

1. **`content` 字段**：从 `String` 升级为 `@db.LongText`（支持最大 4GB）
2. **新增 `contentType` 字段**：支持 `TEXT`、`HTML`、`MARKDOWN` 三种格式
3. **`images` 字段**：保持 `@db.Text`，支持 JSON 数组存储

## 🚀 迁移步骤

### 方法 1：使用 Prisma Migrate（推荐，生产环境）

```bash
# 1. 生成迁移文件
npx prisma migrate dev --name add_post_content_type

# 2. 应用迁移（会自动执行）
# Prisma 会自动检测到 schema 变化并生成 SQL
```

### 方法 2：使用 Prisma Push（开发环境，快速）

```bash
# 直接推送 schema 到数据库（不生成迁移文件）
npx prisma db push
```

### 方法 3：手动 SQL（如果上述方法失败）

```sql
-- 1. 修改 content 字段类型为 LONGTEXT
ALTER TABLE `Post` 
MODIFY COLUMN `content` LONGTEXT NOT NULL;

-- 2. 添加 contentType 字段
ALTER TABLE `Post` 
ADD COLUMN `contentType` VARCHAR(20) NOT NULL DEFAULT 'TEXT';

-- 3. 修改 images 字段类型为 TEXT（如果还不是）
ALTER TABLE `Post` 
MODIFY COLUMN `images` TEXT;
```

## ✅ 验证迁移

迁移完成后，检查：

```bash
# 查看数据库结构
npx prisma studio

# 或直接查询
npx prisma db execute --stdin <<< "DESCRIBE Post;"
```

应该看到：
- `content` 类型为 `longtext`
- `contentType` 字段存在，默认值为 `TEXT`
- `images` 类型为 `text`

## 📝 使用示例

### 创建帖子（API）

```typescript
// POST /api/posts
{
  "title": "我的帖子",
  "content": "这是内容...",  // 可以是纯文本、HTML 或 Markdown
  "contentType": "TEXT",      // 可选：TEXT, HTML, MARKDOWN（默认 TEXT）
  "images": ["url1", "url2"]  // 可选：图片 URL 数组
}
```

### 查询帖子

```typescript
const post = await prisma.post.findUnique({
  where: { id: postId },
  include: { author: true }
})

// post.contentType 可能是 "TEXT", "HTML", 或 "MARKDOWN"
// post.content 是 LONGTEXT，可以存储超大内容
```

## ⚠️ 注意事项

1. **现有数据兼容性**：
   - 所有现有帖子的 `contentType` 会自动设置为 `TEXT`（默认值）
   - 现有 `content` 数据会自动转换为 `LONGTEXT`（MySQL 会自动处理）

2. **性能考虑**：
   - `LONGTEXT` 字段较大，查询时避免 `SELECT *`
   - 建议只查询需要的字段：`SELECT id, title, contentType, LEFT(content, 500) as excerpt`

3. **内容格式**：
   - `TEXT`：纯文本，直接显示
   - `HTML`：需要 `dangerouslySetInnerHTML` 渲染（注意 XSS 防护）
   - `MARKDOWN`：需要使用 Markdown 解析器（如 `react-markdown`）

## 🔧 后续优化建议

1. **添加内容摘要字段**（可选）：
   ```prisma
   excerpt String? @db.VarChar(500)  // 前500字作为摘要
   ```

2. **图片单独表**（如果图片数量多）：
   ```prisma
   model PostImage {
     id        String   @id @default(uuid())
     postId    String
     url       String
     order     Int      @default(0)
   }
   ```

3. **全文搜索优化**：
   ```sql
   -- 为 content 字段添加全文索引（可选）
   ALTER TABLE `Post` 
   ADD FULLTEXT INDEX `idx_content` (`content`);
   ```

## 📚 相关文档

- 详细存储方案：`帖子存储方案说明.md`
- Prisma 文档：https://www.prisma.io/docs
